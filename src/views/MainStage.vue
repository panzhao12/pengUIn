<script setup lang="ts">
import { computed, onMounted, ref, useTemplateRef } from 'vue';
import ThePiano from '@/components/ThePiano.vue';
import type { DialogInput, NoteRecord, RecordedNote } from '@/types';
import { useRecordStore } from '@/stores/recordStore';
import TheSticker from '@/components/TheSticker.vue';
import { sampler } from '@/sampler';
import * as Tone from 'tone';
import TheDialog from '@/components/TheDialog.vue';

const isRecording = ref(false);

const recordStore = useRecordStore();

// All records
const records = computed(() => recordStore.records);

const recordedNotes = ref<RecordedNote[]>();

const penguin = useTemplateRef<HTMLImageElement>('penguin');

// Indicates the current jump position, used for the animation
const currentY = ref(0);

onMounted(() => {
  recordStore.getAllRecords();
});

function toggleRecord() {
  if (isRecording.value) {
    stopAnimation();
  } else {
    startAnimation();
  }
}

function startAnimation() {
  isRecording.value = true;
  currentY.value = 0;
}

function stopAnimation() {
  isRecording.value = false;

  if (!penguin.value) return;

  // extract the Y-axis translation (translateY) from the matrix and update the currentY value
  const computedStyle = window.getComputedStyle(penguin.value);
  const matrix = new DOMMatrix(computedStyle.transform);
  currentY.value = matrix.m42;

  // update the current translateY value
  penguin.value.style.transform = `translateY(${currentY.value}px)`;

  // ensure the code runs in the next animation frame for smooth transition
  requestAnimationFrame(() => {
    if (!penguin.value) return;
    penguin.value.style.transform = 'translateY(0)';
  });
}

function openSaveDialog(notes: RecordedNote[]) {
  recordedNotes.value = notes;
  dialog.value?.open();
}

function playRecord(noteRecord: NoteRecord | undefined) {
  const notes = noteRecord?.record;
  if (!notes) return;

  for (const note of notes) {
    sampler.triggerAttackRelease(
      note.name,
      note.duration,
      Tone.now() + note.startTime
    );
  }
}

// Reference to dialog component
const dialog = ref<InstanceType<typeof TheDialog>>();

// Handle form submission from the dialog
async function handleFormSubmit(input: DialogInput) {
  // do not save if there are less than 2 notes
  if (!recordedNotes.value || recordedNotes.value.length <= 2) return;

  await recordStore.saveRecord(input, recordedNotes.value);
}
</script>

<template>
  <div style="margin: auto">
    <TheSticker
      v-for="[id, record] of records"
      :key="id"
      :id="id"
      :title="record.title"
      :description="record.description"
      :position="record.position"
      @play="playRecord(record)"
    />

    <div class="stage">
      <div class="penguin">
        <svg
          ref="penguin"
          :class="isRecording ? 'penguin-jump' : ''"
          version="1.1"
          xmlns="http://www.w3.org/2000/svg"
          width="180"
          height="180"
          viewBox="0 0 624 624"
          @click="toggleRecord"
          :fill="isRecording ? '#b33e3e' : '#000000'"
        >
          <path
            d="M0 0 C12.7884638 3.60345032 25.16543342 6.60434061 38.49853516 7.1159668 C39.26004883 7.14529297 40.0215625 7.17461914 40.80615234 7.20483398 C41.98032715 7.24979004 41.98032715 7.24979004 43.17822266 7.2956543 C65.06034129 8.17093904 65.06034129 8.17093904 73.81103516 15.1784668 C76.49853516 18.1159668 76.49853516 18.1159668 76.49853516 21.1159668 C75.36158203 21.08116211 74.22462891 21.04635742 73.05322266 21.01049805 C51.22147331 20.53517148 34.55052796 26.52007304 17.49853516 40.1159668 C16.65162109 40.76307617 15.80470703 41.41018555 14.93212891 42.0769043 C10.25721283 45.99392868 6.44507127 50.6549729 4.24853516 56.3659668 C4.53615365 59.52977019 5.41480976 60.71690585 7.78369141 62.78393555 C9.03375033 63.75493804 10.29284696 64.71433831 11.55712891 65.66674805 C27.58803947 77.75244318 35.61544013 92.59079345 38.44313049 112.26493835 C38.96632072 116.08709466 39.45202989 119.91368756 39.93603516 123.7409668 C40.36561637 127.05920471 40.80053437 130.37672887 41.23681641 133.6940918 C41.3970932 134.91804153 41.3970932 134.91804153 41.56060791 136.16671753 C42.45863975 142.96238595 43.52036744 149.72573166 44.62353516 156.4909668 C46.93998645 170.9630078 48.26924598 185.51815784 49.49853516 200.1159668 C49.57201172 200.97464355 49.64548828 201.83332031 49.72119141 202.71801758 C50.09135045 207.18256885 50.34170011 211.63903903 50.49853516 216.1159668 C50.5257666 216.80400391 50.55299805 217.49204102 50.58105469 218.20092773 C51.28808745 238.41583925 48.57552634 258.5188374 46.10400391 278.54174805 C45.91760094 280.05365974 45.91760094 280.05365974 45.72743225 281.59611511 C45.53763039 283.1350518 45.53763039 283.1350518 45.34399414 284.70507812 C45.21548065 285.74741608 45.08696716 286.78975403 44.95455933 287.86367798 C44.69188988 289.99279768 44.42864383 292.12184633 44.16482544 294.25082397 C41.92173531 312.44086415 40.21770713 330.64013718 38.87963867 348.91845703 C37.74599553 364.09464753 36.34655454 379.46520586 31.99853516 394.1159668 C31.75063232 394.95861084 31.50272949 395.80125488 31.24731445 396.66943359 C25.99929218 413.77678332 19.74553853 430.67492768 8.81103516 444.97924805 C4.92978841 450.07070249 4.92978841 450.07070249 3.49853516 456.1159668 C4.25521484 456.65995117 5.01189453 457.20393555 5.79150391 457.7644043 C9.22156825 460.74405615 10.28985045 463.55068492 11.81103516 467.7409668 C12.07464844 468.4215918 12.33826172 469.1022168 12.60986328 469.8034668 C14.49853516 474.76797573 14.49853516 474.76797573 14.49853516 477.1159668 C13.50853516 477.4459668 12.51853516 477.7759668 11.49853516 478.1159668 C11.49853516 480.7559668 11.49853516 483.3959668 11.49853516 486.1159668 C10.23009766 485.48368164 10.23009766 485.48368164 8.93603516 484.83862305 C2.70647778 481.83003 -2.55142681 479.38851731 -9.50146484 479.1159668 C-10.16146484 481.4259668 -10.82146484 483.7359668 -11.50146484 486.1159668 C-16.11619475 485.19302082 -18.27410573 483.45884003 -21.31396484 480.0534668 C-24.70802744 476.54478294 -26.83444783 475.06583043 -31.72802734 474.9284668 C-42.78305456 475.61908956 -42.78305456 475.61908956 -53.50146484 478.1159668 C-53.50146484 478.7759668 -53.50146484 479.4359668 -53.50146484 480.1159668 C-52.80021484 480.38022461 -52.09896484 480.64448242 -51.37646484 480.91674805 C-41.2946226 485.1220817 -34.27634718 489.43961501 -30.06787109 499.56518555 C-26.26731687 509.41352287 -26.26731687 509.41352287 -27.50146484 513.1159668 C-28.38898438 512.50108398 -28.38898438 512.50108398 -29.29443359 511.8737793 C-30.47972656 511.06553711 -30.47972656 511.06553711 -31.68896484 510.2409668 C-32.85492188 509.44045898 -32.85492188 509.44045898 -34.04443359 508.6237793 C-38.52203491 505.87599852 -42.20799616 504.54058977 -47.50146484 505.1159668 C-49.87637783 506.83792317 -50.45814404 507.95588832 -51.23193359 510.81518555 C-51.38275391 511.80131836 -51.53357422 512.78745117 -51.68896484 513.8034668 C-51.84751953 514.79733398 -52.00607422 515.79120117 -52.16943359 516.81518555 C-52.27900391 517.57444336 -52.38857422 518.33370117 -52.50146484 519.1159668 C-53.16146484 519.1159668 -53.82146484 519.1159668 -54.50146484 519.1159668 C-54.99517578 518.18913086 -55.48888672 517.26229492 -55.99755859 516.30737305 C-56.64459983 515.09768725 -57.29174039 513.88805458 -57.93896484 512.6784668 C-58.26445312 512.06680664 -58.58994141 511.45514648 -58.92529297 510.82495117 C-60.43861627 507.77880474 -60.43861627 507.77880474 -62.50146484 505.1159668 C-64.06965446 505.06515542 -65.64008024 505.08051068 -67.20849609 505.1237793 C-83.07299983 505.43755093 -95.47179717 505.20411967 -108.50146484 495.1159668 C-109.73768579 493.91485152 -110.94895081 492.6871887 -112.12646484 491.4284668 C-117.54246433 485.78575105 -123.595883 484.22800236 -131.10302734 482.82739258 C-148.19288845 479.62304362 -161.00440793 471.85025716 -174.50146484 461.1159668 C-175.08250977 460.6627002 -175.66355469 460.20943359 -176.26220703 459.74243164 C-177.71500473 458.58163863 -179.11380558 457.35389383 -180.50146484 456.1159668 C-180.50146484 455.4559668 -180.50146484 454.7959668 -180.50146484 454.1159668 C-179.7108667 454.04079834 -178.92026855 453.96562988 -178.10571289 453.88818359 C-174.46577058 453.53644569 -170.82744084 453.17005009 -167.18896484 452.8034668 C-165.94566406 452.68551758 -164.70236328 452.56756836 -163.42138672 452.44604492 C-150.33079572 451.38701057 -150.33079572 451.38701057 -138.68896484 445.9909668 C-136.85753826 441.55698664 -137.84226647 438.40574879 -139.50146484 434.1159668 C-144.22415284 423.41519273 -150.19151171 415.33194631 -158.50146484 407.1159668 C-159.10345703 406.51268555 -159.70544922 405.9094043 -160.32568359 405.2878418 C-160.71369141 404.90112305 -161.10169922 404.5144043 -161.50146484 404.1159668 C-162.01708984 404.7759668 -162.53271484 405.4359668 -163.06396484 406.1159668 C-166.3014224 408.77234222 -168.42698766 408.42938812 -172.50146484 408.1159668 C-173.7693529 405.58019069 -173.46713103 404.15962533 -173.24755859 401.3347168 C-172.05676115 378.76875698 -176.98460073 357.78332227 -181.68676758 335.82606506 C-183.41829316 327.68263666 -184.88497199 319.54556713 -186.06396484 311.3034668 C-186.20737305 310.31781738 -186.35078125 309.33216797 -186.49853516 308.31665039 C-186.8732248 305.58601579 -187.20169207 302.85579083 -187.50146484 300.1159668 C-187.64962646 298.78432495 -187.64962646 298.78432495 -187.80078125 297.42578125 C-190.47873122 268.83640594 -190.86168879 237.37464963 -185.50146484 209.1159668 C-185.31825684 208.08987305 -185.13504883 207.0637793 -184.94628906 206.0065918 C-181.55529422 187.70233552 -175.81379625 170.09984139 -170.06396484 152.4284668 C-169.52349518 150.7607724 -169.52349518 150.7607724 -168.97210693 149.05938721 C-165.40349709 138.10026105 -161.72437032 127.22038639 -157.27099609 116.5847168 C-156.96335831 115.8496138 -156.65572052 115.1145108 -156.33876038 114.35713196 C-148.09065575 95.24142346 -135.14535329 78.83230069 -121.98095703 62.90698242 C-119.99781848 60.50627212 -118.03140221 58.09205167 -116.06396484 55.6784668 C-113.43202662 52.46488477 -110.79434184 49.25608027 -108.15380859 46.04956055 C-107.55721436 45.32502686 -106.96062012 44.60049316 -106.34594727 43.85400391 C-105.1193187 42.36565128 -103.89162154 40.87817868 -102.6628418 39.39160156 C-100.06618971 36.24754524 -97.47541107 33.10255371 -94.95458984 29.8972168 C-69.45264659 -2.29672575 -38.85444223 -11.01980938 0 0 Z M-85.99365234 29.54174805 C-89.62512962 33.69968208 -91.28267853 37.11042555 -91.87646484 42.5534668 C-91.42007041 46.88921392 -90.34057659 48.82857425 -87.50146484 52.1159668 C-82.83387871 54.90123769 -78.40222973 55.93053282 -73.12646484 56.8034668 C-72.39041016 56.93301758 -71.65435547 57.06256836 -70.89599609 57.19604492 C-69.09926647 57.51105596 -67.30054921 57.81469495 -65.50146484 58.1159668 C-65.50146484 62.1159668 -65.50146484 62.1159668 -67.54833984 64.5534668 C-68.88638672 65.8219043 -68.88638672 65.8219043 -70.25146484 67.1159668 C-71.13318359 67.9615918 -72.01490234 68.8072168 -72.92333984 69.6784668 C-73.77412109 70.4828418 -74.62490234 71.2872168 -75.50146484 72.1159668 C-76.17951172 72.82495117 -76.85755859 73.53393555 -77.55615234 74.2644043 C-79.55061679 76.16274997 -81.49323803 77.3779283 -83.87646484 78.7409668 C-96.9632465 87.3439167 -100.55522255 107.75861023 -105.31396484 121.9284668 C-105.57569489 122.70576141 -105.83742493 123.48305603 -106.10708618 124.28390503 C-110.01817527 135.96252782 -113.33400505 147.67570002 -116.1557312 159.66107178 C-118.3936335 169.1591848 -121.14138514 178.34443736 -124.37646484 187.5534668 C-128.82783621 200.37549276 -130.59346604 211.88005786 -130.56005859 225.40893555 C-130.55901123 226.18400452 -130.55796387 226.95907349 -130.55688477 227.75762939 C-130.52784663 235.7937322 -130.30833465 243.82254721 -130.07339478 251.85479736 C-127.12027767 354.95203719 -127.12027767 354.95203719 -152.25146484 392.26831055 C-154.43668655 395.69686261 -155.28877964 397.98256413 -154.50146484 402.1159668 C-153.07142214 404.55390261 -153.07142214 404.55390261 -151.00146484 406.7409668 C-147.88175525 410.39893615 -145.11605171 414.0799577 -142.50146484 418.1159668 C-136.68019478 427.00226707 -130.31737697 435.11784142 -122.12646484 441.9284668 C-119.48927939 444.13938305 -117.31200218 446.45993184 -115.12646484 449.1159668 C-101.85492304 464.49224651 -80.39497283 467.34904413 -61.31787109 468.79174805 C-38.7685232 470.21780825 -22.39509556 463.97541584 -5.50146484 449.1159668 C9.62181413 435.63166387 16.73451167 419.29073473 22.83789062 400.41186523 C23.61675005 398.01187453 24.41444173 395.61871175 25.21337891 393.2253418 C31.02791586 375.54790696 32.97550119 358.48789895 34.14874268 339.95327759 C35.66965206 316.10498069 37.90229987 292.39630937 40.64306641 268.6608429 C42.86757902 249.42878091 42.86757902 249.42878091 44.12353516 230.1159668 C44.16075684 229.23626221 44.19797852 228.35655762 44.23632812 227.45019531 C44.49495077 220.99952686 44.68093491 214.57133217 44.49853516 208.1159668 C44.48064941 207.42277344 44.46276367 206.72958008 44.44433594 206.01538086 C44.17975292 196.80325693 43.58036793 187.70379241 42.22509766 178.5847168 C42.09500809 177.69438248 41.96491852 176.80404816 41.83088684 175.88673401 C40.27269733 165.37397314 38.54593281 154.88919975 36.7565918 144.41357422 C36.37607459 142.17264209 36.00107659 139.93076583 35.6315918 137.68798828 C29.93152584 98.99816377 29.93152584 98.99816377 9.31494141 67.3659668 C4.69821894 64.38415706 0.71927031 63.03089365 -4.78662109 62.6862793 C-5.86266602 62.61473633 -6.93871094 62.54319336 -8.04736328 62.46948242 C-9.2078418 62.39407227 -10.36832031 62.31866211 -11.56396484 62.2409668 C-21.31791337 61.56101037 -31.03595833 60.71941509 -40.75146484 59.6159668 C-42.36420288 59.43831787 -42.36420288 59.43831787 -44.00952148 59.25708008 C-49.37008189 58.62873288 -54.36907072 57.79776826 -59.50146484 56.1159668 C-59.69773875 54.53369715 -59.88312022 52.95007409 -60.06396484 51.3659668 C-60.22058594 50.04338867 -60.22058594 50.04338867 -60.38037109 48.6940918 C-60.49764688 46.19725254 -60.19623773 44.49100603 -59.50146484 42.1159668 C-59.01948336 37.7781334 -59.11524712 35.73889861 -61.43896484 31.9909668 C-64.77904313 28.44094074 -69.00166545 25.93520591 -73.50146484 24.1159668 C-78.71758081 24.1159668 -82.28162463 25.99491528 -85.99365234 29.54174805 Z "
            transform="translate(383.50146484375,53.884033203125)"
          />
        </svg>
      </div>

      <ThePiano
        :is-recording="isRecording"
        @update:record="(recordedNotes: RecordedNote[]) => openSaveDialog(recordedNotes)"
      />
    </div>

    <TheDialog style="z-index: 12" ref="dialog" @submit="handleFormSubmit">
      <h2>Enter information</h2>
    </TheDialog>
  </div>
</template>

<style scoped lang="scss">
.stage {
  transform: scale(1.12);
}

.penguin {
  display: flex;
  justify-content: center;

  & svg {
    cursor: pointer;
    transition: transform 0.3s ease-out;
  }
}

.penguin-jump {
  animation: jump 1s ease-in-out infinite;
}

@keyframes jump {
  0%,
  100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-30px);
  }
}
</style>
